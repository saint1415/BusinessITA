(function(){const { setTheme, initTheme, bindIncidentFields, populateTemplateList, buildRenderedOutput, validateIncidentId } = window.BITA_UI; document.addEventListener("DOMContentLoaded",()=>{ initTheme(); bindIncidentFields(); populateTemplateList(); document.getElementById("themeToggle").addEventListener("click",()=>{ const next=document.documentElement.getAttribute("data-theme")==="light"?"dark":"light"; setTheme(next)}); document.querySelectorAll(".tab").forEach(tab=>{ tab.addEventListener("click",()=>{ document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); document.querySelectorAll(".tabpanel").forEach(p=>p.classList.remove("active")); tab.classList.add("active"); document.getElementById(tab.dataset.tab).classList.add("active"); if(tab.dataset.tab==="rendered"||tab.dataset.tab==="preview") buildRenderedOutput(); }); }); document.getElementById("applyTemplate").addEventListener("click",()=>{ const form=document.getElementById("tokenForm"); const fields=form.querySelectorAll("[data-token]"); const mapBack={ INCIDENT_NAME:"name", SEVERITY:"severity", START_TIME:"start_time", NEXT_UPDATE_TIME:"next_update_time", IMPACT_SUMMARY:"impact_summary", IC_NAME:"ic_name", CONTACT:"contact", CUSTOMERS_AFFECTED:"customers_affected", "$IMPACT":"dollar_impact_per_hour", DOLLAR_IMPACT_PER_HOUR:"dollar_impact_per_hour", CURRENT_STATUS:"current_status", ROOT_CAUSE_STATUS:"root_cause_status", ETA:"eta", LINK_STATUS_PAGE:"link_status_page", JURISDICTION:"jurisdiction", TICKET_ID:"ticket_id", INCIDENT_ID:"incident_id" }; fields.forEach(el=>{ const key=mapBack[el.dataset.token]; if(key) window.BITA_STORE.incident[key]=el.value; }); alert("Incident fields updated from template tokens."); }); document.getElementById("generateId").addEventListener("click",()=>{ const now=new Date(); const yyyymm=now.toISOString().slice(0,7).replace("-",""); const ids=(window.BITA_STORE._idsSeen||[]).filter(id=>id.startsWith(yyyymm+"_")); let maxNN=0; ids.forEach(id=>{ const m=id.match(/^\d{6}_(\d{2})/); if(m) maxNN=Math.max(maxNN,parseInt(m[1],10)); }); const nextNN=String(maxNN+1).padStart(2,"0"); const newId=`${yyyymm}_${nextNN}`; window.BITA_STORE.incident.incident_id=newId; window.BITA_STORE.incident.revision="00"; window.BITA_STORE._idsSeen=Array.from(new Set([...(window.BITA_STORE._idsSeen||[]), newId])); const el=document.getElementById("incidentId"); el.value=newId; validateIncidentId(newId); }); document.getElementById("saveRevision").addEventListener("click",()=>{ const id=window.BITA_STORE.incident.incident_id||""; if(!/^\d{6}_\d{2}$/.test(id) && !/^\d{6}_\d{2}\.\d{2}$/.test(id)) { alert("Set a valid Incident ID first (YYYYMM_NN or YYYYMM_NN.RR)."); return; } let base=id, rr=null; const m=id.match(/^\d{6}_\d{2}\.\d{2}$/); if(m){ rr=parseInt(id.slice(-2),10); base=id.slice(0,id.lastIndexOf(".")); } const currentRR=(rr!==null)?rr:parseInt(window.BITA_STORE.incident.revision||"00",10); const nextRR=String(currentRR+1).padStart(2,"0"); const newId=`${base}.${nextRR}`; window.BITA_STORE.incident.incident_id=newId; window.BITA_STORE.incident.revision=nextRR; const el=document.getElementById("incidentId"); el.value=newId; validateIncidentId(newId); alert(`Revision saved: ${newId}`); }); document.getElementById("uploadIncident").addEventListener("change", async (evt)=>{ const file=evt.target.files[0]; if(!file) return; const text=await file.text(); try { const data=JSON.parse(text); window.BITA_STORE.incident={ ...window.BITA_STORE.incident, ...data }; const mapping={ incident_id:"incidentId", name:"incidentName", severity:"incidentSeverity", start_time:"startTime", next_update_time:"nextUpdateTime", impact_summary:"impactSummary", ic_name:"icName", contact:"contact", customers_affected:"customersAffected", dollar_impact_per_hour:"dollarImpactPerHour", current_status:"currentStatus", root_cause_status:"rootCauseStatus", eta:"eta", link_status_page:"linkStatusPage", jurisdiction:"jurisdiction", ticket_id:"ticketId" }; Object.entries(mapping).forEach(([k,id])=>{ const el=document.getElementById(id); if(el && data[k]!==undefined) el.value=data[k]; }); if(data.incident_id){ window.BITA_STORE._idsSeen=Array.from(new Set([...(window.BITA_STORE._idsSeen||[]), data.incident_id])); validateIncidentId(data.incident_id); } alert("Incident loaded."); } catch(e) { alert("Invalid incident JSON."); } }); document.getElementById("uploadRendered").addEventListener("change", async (evt)=>{ const files=Array.from(evt.target.files||[]); if(!files.length) return; let updates=0; for(const f of files){ const text=await f.text(); const { incident }=window.BITA_PARSER.updateIncidentFromRendered(text, window.BITA_STORE.incident); window.BITA_STORE.incident=incident; updates++; } const idEl=document.getElementById("incidentId"); if(window.BITA_STORE.incident.incident_id){ idEl.value=window.BITA_STORE.incident.incident_id; validateIncidentId(idEl.value); } alert(`Processed ${updates} file(s). Incident fields updated (metadata preferred).`); }); document.getElementById("downloadIncident").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(window.BITA_STORE.incident,null,2)], { type:"application/json" }); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); const base=window.BITA_STORE.incident.incident_id||"incident"; a.download=`${base}.json`; a.click(); }); document.getElementById("downloadBundle").addEventListener("click",()=>{ const parts=[]; const txt=window.BITA_STORE.rendered.text||""; if(txt) parts.push({ name:"rendered.txt", content:txt }); parts.push({ name:"incident.json", content:JSON.stringify(window.BITA_STORE.incident,null,2) }); const payload=parts.map(p=>`===== ${p.name} =====
${p.content}`).join("

"); const blob=new Blob([payload], { type:"text/plain" }); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); const base=window.BITA_STORE.incident.incident_id||"bundle"; a.download=`${base}_bundle.txt`; a.click(); }); document.getElementById("copyRendered").addEventListener("click", async ()=>{ const txt=document.getElementById("renderedText").textContent; try{ await navigator.clipboard.writeText(txt); alert("Copied to clipboard."); } catch { alert("Copy failed. Select and copy manually."); } }); document.getElementById("downloadRenderedTxt").addEventListener("click",()=>{ const txt=document.getElementById("renderedText").textContent||""; const blob=new Blob([txt], { type:"text/plain" }); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); const base=window.BITA_STORE.incident.incident_id||"rendered"; a.download=`${base}.txt`; a.click(); }); document.getElementById("generateComms").addEventListener("click",()=>{ const selectedAud=Array.from(document.getElementById("audienceSelect").selectedOptions).map(o=>o.value); const severity=document.getElementById("incidentSeverity").value; const templates=window.BITA_STORE.templates.communications.filter(t=> selectedAud.includes(t.audience) && (!severity || (t.severity||[]).includes(severity)) ); if(!templates.length){ alert("No templates match selected audience/severity."); return; } window.BITA_UI.selectTemplate(templates[0]); document.querySelector('.tab[data-tab="editor"]').click(); }); });})();